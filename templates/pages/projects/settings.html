{{ define "title" }}Project Settings - {{ .project.Name }}{{ end }}

{{ define "content" }}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Project Settings</h1>
            <p class="text-sm text-gray-500 mt-1">Configure {{ .project.Name }}</p>
        </div>
        <a href="/projects/{{ .project.ID }}" class="btn btn-secondary text-sm">Back to Project</a>
    </div>

    <!-- Flash Messages -->
    {{ if .flashType }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            showToast('{{ .flashMessage }}', '{{ .flashType }}');
        });
    </script>
    {{ end }}

    <!-- Tabs -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" id="settings-tabs">
            <a href="/projects/{{ .project.ID }}/settings?tab=general"
               class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{ if eq .activeTab "general" }}border-brand-500 text-brand-600{{ else }}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{ end }}"
               data-tab="general">General</a>
            <a href="/projects/{{ .project.ID }}/settings?tab=company"
               class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{ if eq .activeTab "company" }}border-brand-500 text-brand-600{{ else }}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{ end }}"
               data-tab="company">Company Info</a>
            <a href="/projects/{{ .project.ID }}/settings?tab=dc_config"
               class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{ if eq .activeTab "dc_config" }}border-brand-500 text-brand-600{{ else }}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{ end }}"
               data-tab="dc_config">DC Configuration</a>
            <a href="/projects/{{ .project.ID }}/settings?tab=tender"
               class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{ if eq .activeTab "tender" }}border-brand-500 text-brand-600{{ else }}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{ end }}"
               data-tab="tender">Tender/PO</a>
        </nav>
    </div>

    <!-- Tab Content -->
    <form method="POST" action="/projects/{{ .project.ID }}/settings" enctype="multipart/form-data" class="space-y-6">
        {{ .csrfField }}
        <input type="hidden" name="tab" value="{{ .activeTab }}">

        {{ if eq .activeTab "general" }}
        <!-- General Tab -->
        <div class="card space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">General Information</h2>

            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Project Name *</label>
                <input type="text" id="name" name="name" value="{{ .project.Name }}" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm {{ if index .errors "name" }}border-red-300{{ end }}">
                {{ if index .errors "name" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "name" }}</p>{{ end }}
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="description" name="description" rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">{{ .project.Description }}</textarea>
            </div>

            <div>
                <label for="dc_prefix" class="block text-sm font-medium text-gray-700">DC Prefix *</label>
                <input type="text" id="dc_prefix" name="dc_prefix" value="{{ .project.DCPrefix }}" required maxlength="10"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm {{ if index .errors "dc_prefix" }}border-red-300{{ end }}">
                <p class="mt-1 text-sm text-gray-500">Used as prefix in delivery challan numbers (max 10 chars)</p>
                {{ if index .errors "dc_prefix" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "dc_prefix" }}</p>{{ end }}
            </div>
        </div>

        {{ else if eq .activeTab "company" }}
        <!-- Company Info Tab -->
        <div class="card space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Company Information</h2>

            <div>
                <label for="bill_from_address" class="block text-sm font-medium text-gray-700">Bill From Address</label>
                <textarea id="bill_from_address" name="bill_from_address" rows="4"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">{{ .project.BillFromAddress }}</textarea>
                <p class="mt-1 text-sm text-gray-500">Company billing address shown on DCs</p>
            </div>

            <div>
                <label for="dispatch_from_address" class="block text-sm font-medium text-gray-700">Dispatch From Address</label>
                <textarea id="dispatch_from_address" name="dispatch_from_address" rows="4"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">{{ .project.DispatchFromAddress }}</textarea>
                <p class="mt-1 text-sm text-gray-500">Warehouse/dispatch location</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="company_gstin" class="block text-sm font-medium text-gray-700">GSTIN</label>
                    <input type="text" id="company_gstin" name="company_gstin" value="{{ .project.CompanyGSTIN }}" maxlength="15"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm {{ if index .errors "company_gstin" }}border-red-300{{ end }}">
                    {{ if index .errors "company_gstin" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "company_gstin" }}</p>{{ end }}
                </div>
                <div>
                    <label for="company_email" class="block text-sm font-medium text-gray-700">Company Email</label>
                    <input type="email" id="company_email" name="company_email" value="{{ .project.CompanyEmail }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm {{ if index .errors "company_email" }}border-red-300{{ end }}">
                    {{ if index .errors "company_email" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "company_email" }}</p>{{ end }}
                </div>
            </div>

            <div>
                <label for="company_cin" class="block text-sm font-medium text-gray-700">Company CIN</label>
                <input type="text" id="company_cin" name="company_cin" value="{{ .project.CompanyCIN }}"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Company Signature</label>
                    {{ if .project.CompanySignaturePath }}
                    <div class="mt-1 mb-2">
                        <img src="/static/uploads/{{ .project.CompanySignaturePath }}" alt="Current signature" class="h-16 border rounded p-1">
                    </div>
                    {{ end }}
                    <input type="file" name="company_signature" accept="image/*"
                        class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                    {{ if index .errors "company_signature" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "company_signature" }}</p>{{ end }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Company Seal</label>
                    {{ if .project.CompanySealPath }}
                    <div class="mt-1 mb-2">
                        <img src="/static/uploads/{{ .project.CompanySealPath }}" alt="Current seal" class="h-16 border rounded p-1">
                    </div>
                    {{ end }}
                    <input type="file" name="company_seal" accept="image/*"
                        class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                    {{ if index .errors "company_seal" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "company_seal" }}</p>{{ end }}
                </div>
            </div>
        </div>

        {{ else if eq .activeTab "dc_config" }}
        <!-- DC Configuration Tab -->
        <div class="card space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">DC Number Format</h2>

            <div>
                <label for="dc_number_format" class="block text-sm font-medium text-gray-700">Number Format Pattern</label>
                <input type="text" id="dc_number_format" name="dc_number_format" value="{{ .project.DCNumberFormat }}"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm font-mono"
                    oninput="updateDCPreview()">
                <p class="mt-1 text-sm text-gray-500">
                    Available tokens: <code class="bg-gray-100 px-1 rounded">{PREFIX}</code>
                    <code class="bg-gray-100 px-1 rounded">{PROJECT_CODE}</code>
                    <code class="bg-gray-100 px-1 rounded">{FY}</code>
                    <code class="bg-gray-100 px-1 rounded">{SEQ}</code>
                    <code class="bg-gray-100 px-1 rounded">{TYPE}</code>
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Live Preview</label>
                <div id="dc-preview" class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-200 font-mono text-lg text-brand-700">
                    {{ .dcPreview }}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="seq_padding" class="block text-sm font-medium text-gray-700">Sequence Padding (digits)</label>
                    <select id="seq_padding" name="seq_padding" onchange="updateDCPreview()"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
                        <option value="2" {{ if eq .project.SeqPadding 2 }}selected{{ end }}>2 (01, 02...)</option>
                        <option value="3" {{ if eq .project.SeqPadding 3 }}selected{{ end }}>3 (001, 002...)</option>
                        <option value="4" {{ if eq .project.SeqPadding 4 }}selected{{ end }}>4 (0001, 0002...)</option>
                        <option value="5" {{ if eq .project.SeqPadding 5 }}selected{{ end }}>5 (00001, 00002...)</option>
                        <option value="6" {{ if eq .project.SeqPadding 6 }}selected{{ end }}>6 (000001, 000002...)</option>
                    </select>
                    {{ if index .errors "seq_padding" }}<p class="mt-1 text-sm text-red-600">{{ index .errors "seq_padding" }}</p>{{ end }}
                </div>
                <div>
                    <label for="dc_number_separator" class="block text-sm font-medium text-gray-700">Separator (legacy)</label>
                    <input type="text" id="dc_number_separator" name="dc_number_separator" value="{{ .project.DCNumberSeparator }}" maxlength="3"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
                </div>
            </div>

            <div>
                <label for="purpose_text" class="block text-sm font-medium text-gray-700">Purpose Text</label>
                <input type="text" id="purpose_text" name="purpose_text" value="{{ .project.PurposeText }}"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">Default purpose text shown on delivery challans</p>
            </div>
        </div>

        {{ else if eq .activeTab "tender" }}
        <!-- Tender/PO Tab -->
        <div class="card space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Tender & Purchase Order</h2>

            <div>
                <label for="tender_ref_number" class="block text-sm font-medium text-gray-700">Tender Reference Number</label>
                <input type="text" id="tender_ref_number" name="tender_ref_number" value="{{ .project.TenderRefNumber }}"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
            </div>

            <div>
                <label for="tender_ref_details" class="block text-sm font-medium text-gray-700">Tender Reference Details</label>
                <textarea id="tender_ref_details" name="tender_ref_details" rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">{{ .project.TenderRefDetails }}</textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="po_reference" class="block text-sm font-medium text-gray-700">PO Reference</label>
                    <input type="text" id="po_reference" name="po_reference" value="{{ .project.POReference }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
                </div>
                <div>
                    <label for="po_date" class="block text-sm font-medium text-gray-700">PO Date</label>
                    <input type="date" id="po_date" name="po_date" value="{{ if .project.PODate }}{{ derefStr .project.PODate }}{{ end }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm">
                </div>
            </div>
        </div>
        {{ end }}

        <!-- Save Button -->
        <div class="flex justify-end">
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>

<script>
function updateDCPreview() {
    const format = document.getElementById('dc_number_format').value;
    const padding = document.getElementById('seq_padding').value;
    const prefix = '{{ .project.DCPrefix }}';

    fetch(`/projects/{{ .project.ID }}/settings/dc-preview?format=${encodeURIComponent(format)}&prefix=${encodeURIComponent(prefix)}&padding=${padding}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('dc-preview').textContent = data.preview;
        });
}
</script>
{{ end }}
