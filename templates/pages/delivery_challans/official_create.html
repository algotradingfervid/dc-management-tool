{{ define "title" }}Create Official DC{{ end }}

{{ define "content" }}
<div class="max-w-4xl mx-auto space-y-6">

    {{ if .errors.general }}
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
        {{ .errors.general }}
    </div>
    {{ end }}

    {{ if .errors.serial_numbers }}
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
        {{ .errors.serial_numbers }}
    </div>
    {{ end }}

    <form method="POST" action="/projects/{{ .project.ID }}/dcs/official" id="officialDCForm">
        {{ .csrfField }}

        <!-- Section 1: Template Selection -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 sm:p-6 mb-6">
            <h2 class="text-base font-bold text-gray-800 mb-4">Template</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Template <span class="text-red-500">*</span></label>
                    <select name="template_id" id="templateSelect"
                            onchange="changeTemplate(this)"
                            class="w-full h-10 px-3 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-lg">
                        <option value="">Select a template...</option>
                        {{ range .templates }}
                        <option value="{{ .ID }}" {{ if $.template }}{{ if eq .ID $.template.ID }}selected{{ end }}{{ end }}>
                            {{ .Name }} ({{ .ProductCount }} products)
                        </option>
                        {{ end }}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Purpose</label>
                    <input type="text" name="purpose" value="{{ .purpose }}" readonly
                           class="w-full h-10 px-3 text-sm text-gray-900 bg-gray-100 border border-gray-200 rounded-lg">
                </div>
            </div>
        </section>

        <!-- Section 2: DC Information -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 sm:p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-bold text-gray-800">DC Information</h2>
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">OFFICIAL DC</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Official DC Number</label>
                    <div class="h-10 px-3 flex items-center text-sm font-mono font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">
                        {{ .dcNumber }}
                        <span class="ml-auto text-xs text-gray-400 font-sans font-normal">Auto</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">DC Date <span class="text-red-500">*</span></label>
                    <input type="date" name="challan_date" value="{{ .challanDate }}" required
                           class="w-full h-10 px-3 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-lg {{ if .errors.challan_date }}border-red-300{{ end }}">
                    {{ if .errors.challan_date }}
                    <p class="text-xs text-red-500 mt-1">{{ .errors.challan_date }}</p>
                    {{ end }}
                </div>
            </div>
        </section>

        <!-- Section 3: Addresses -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 sm:p-6 mb-6">
            <h2 class="text-base font-bold text-gray-800 mb-4">Addresses</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Bill To</label>
                    <select name="bill_to_address_id" id="billToSelect" onchange="updateAddressPreview('billTo', this)"
                            class="w-full h-10 px-3 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-lg">
                        <option value="">None (optional)</option>
                        {{ range .billToAddresses }}
                        <option value="{{ .ID }}" data-address='{{ toJSON .Data }}'>
                            {{ addressLabel .Data $.billToColumns }}
                        </option>
                        {{ end }}
                    </select>
                    <div id="billToPreview" class="mt-2 p-3 bg-gray-50 rounded-lg text-xs text-gray-500 leading-relaxed border border-gray-100 hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Ship To <span class="text-red-500">*</span></label>
                    <select name="ship_to_address_id" id="shipToSelect" onchange="updateAddressPreview('shipTo', this)" required
                            class="w-full h-10 px-3 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-lg {{ if .errors.ship_to_address_id }}border-red-300{{ end }}">
                        <option value="">Select ship-to address...</option>
                        {{ range .shipToAddresses }}
                        <option value="{{ .ID }}" data-address='{{ toJSON .Data }}'>
                            {{ addressLabel .Data $.shipToColumns }}
                        </option>
                        {{ end }}
                    </select>
                    {{ if .errors.ship_to_address_id }}
                    <p class="text-xs text-red-500 mt-1">{{ .errors.ship_to_address_id }}</p>
                    {{ end }}
                    <div id="shipToPreview" class="mt-2 p-3 bg-gray-50 rounded-lg text-xs text-gray-500 leading-relaxed border border-gray-100 hidden"></div>
                </div>
            </div>
        </section>

        <!-- Section 4: Product Lines (No pricing) -->
        <section class="space-y-4 mb-6" id="productLines">
            <div class="flex items-center justify-between px-1">
                <h2 class="text-base font-bold text-gray-800">Product Lines</h2>
                <span class="text-xs text-gray-400 font-medium">No pricing for Official DCs</span>
            </div>

            {{ if .errors.line_items }}
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                {{ .errors.line_items }}
            </div>
            {{ end }}

            {{ if .products }}
            {{ range $index, $product := .products }}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden product-card" data-index="{{ $index }}">
                <!-- Product Header -->
                <div class="bg-gray-50 border-b border-gray-200 px-5 sm:px-6 py-4">
                    <h3 class="text-sm font-bold text-gray-800">{{ add $index 1 }}. {{ $product.ItemName }} &mdash; {{ $product.BrandModel }}</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ $product.ItemDescription }}</p>
                    <div class="flex flex-wrap gap-x-5 gap-y-1 mt-2.5 text-xs text-gray-500">
                        {{ if $product.HSNCode }}<span>HSN: <strong class="text-gray-700">{{ $product.HSNCode }}</strong></span>{{ end }}
                        <span>UoM: <strong class="text-gray-700">{{ $product.UoM }}</strong></span>
                    </div>
                </div>

                <input type="hidden" name="line_items[{{ $index }}].product_id" value="{{ $product.ID }}">

                <div class="px-5 sm:px-6 py-5 space-y-4">
                    <!-- Serial Numbers -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Serial Numbers <span class="text-gray-400 font-normal text-xs">(one per line, scan or type)</span></label>
                        <textarea name="line_items[{{ $index }}].serial_numbers" rows="4"
                                  oninput="recalcQuantity({{ $index }})"
                                  class="serial-textarea w-full px-3 py-2.5 text-gray-900 bg-gray-50 border border-gray-200 rounded-lg resize-y font-mono text-sm"
                                  placeholder="Scan or enter serial numbers here..."></textarea>
                    </div>

                    <!-- Quantity Display -->
                    <div class="bg-gray-50 rounded-lg border border-gray-200 px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Quantity</div>
                            <div id="qty-{{ $index }}" class="text-lg font-bold text-gray-800">0</div>
                            <span class="text-xs text-gray-400">items</span>
                        </div>
                    </div>
                </div>
            </div>
            {{ end }}
            {{ else }}
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center text-sm text-gray-500">
                Select a template above to load product lines.
            </div>
            {{ end }}
        </section>

        <!-- Section 5: Notes -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 sm:p-6 mb-6">
            <h2 class="text-base font-bold text-gray-800 mb-4">Notes</h2>
            <textarea name="notes" rows="3" placeholder="Optional notes..."
                      class="w-full px-3 py-2.5 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-lg resize-y"></textarea>
        </section>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end gap-3 pt-2">
            <a href="/projects/{{ .project.ID }}" class="h-10 px-5 text-sm font-semibold text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 inline-flex items-center">
                Cancel
            </a>
            <button type="submit" class="h-10 px-6 text-sm font-semibold text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-sm">
                Save as Draft
            </button>
        </div>
    </form>
</div>

<style>
.serial-textarea {
    line-height: 1.75;
    letter-spacing: 0.025em;
}
</style>

<script>
function changeTemplate(selectEl) {
    var templateId = selectEl.value;
    var projectId = {{ .project.ID }};
    var url = '/projects/' + projectId + '/dcs/official/new';
    if (templateId) {
        url += '?template_id=' + templateId;
    }
    window.location.href = url;
}

// Official DC: only quantity calculation, no pricing
function recalcQuantity(index) {
    var textarea = document.querySelector('textarea[name="line_items[' + index + '].serial_numbers"]');
    if (!textarea) return;

    var lines = textarea.value.split('\n').filter(function(l) { return l.trim().length > 0; });
    document.getElementById('qty-' + index).textContent = lines.length;
}

function updateAddressPreview(type, selectEl) {
    var previewDiv = document.getElementById(type + 'Preview');
    var option = selectEl.options[selectEl.selectedIndex];
    if (!option || !option.value) {
        previewDiv.classList.add('hidden');
        previewDiv.innerHTML = '';
        return;
    }

    var dataStr = option.getAttribute('data-address');
    if (!dataStr) {
        previewDiv.classList.add('hidden');
        return;
    }

    try {
        var data = JSON.parse(dataStr);
        var html = '';
        for (var key in data) {
            if (data[key]) {
                html += '<strong>' + key + ':</strong> ' + data[key] + '<br>';
            }
        }
        previewDiv.innerHTML = html;
        previewDiv.classList.remove('hidden');
    } catch(e) {
        previewDiv.classList.add('hidden');
    }
}
</script>
<script src="/static/js/serial_validation.js"></script>
{{ end }}
