{{ define "title" }}New Shipment - Addresses{{ end }}

{{ define "content" }}
<div class="max-w-4xl mx-auto">
    {{ template "wizard_steps" . }}

    <form method="POST" action="{{.basePath}}/shipments/wizard/step3" id="wizard-step2-form">
        {{ .csrfField }}

        <!-- Hidden fields carrying step 1 data -->
        <input type="hidden" name="template_id" value="{{.formData.TemplateID}}">
        <input type="hidden" name="num_sets" value="{{.formData.NumSets}}">
        <input type="hidden" name="challan_date" value="{{.formData.ChallanDate}}">
        <input type="hidden" name="transporter_name" value="{{.formData.TransporterName}}">
        <input type="hidden" name="vehicle_number" value="{{.formData.VehicleNumber}}">
        <input type="hidden" name="docket_number" value="{{.formData.DocketNumber}}">
        <input type="hidden" name="eway_bill_number" value="{{.formData.EwayBillNumber}}">
        <input type="hidden" name="tax_type" value="{{.formData.TaxType}}">
        <input type="hidden" name="reverse_charge" value="{{.formData.ReverseCharge}}">

        <!-- Product rate/gst overrides -->
        {{range $i, $p := .formData.Products}}
        <input type="hidden" name="product_{{$p.ProductID}}_rate" value="{{$p.Rate}}">
        <input type="hidden" name="product_{{$p.ProductID}}_gst" value="{{$p.GSTPercentage}}">
        {{end}}

        <div class="card mb-6">
            <div class="space-y-6">

                <!-- Bill From Address -->
                <div>
                    <label for="bill_from_address_id" class="block text-sm font-medium text-gray-700 mb-1">Bill From Address</label>
                    <select name="bill_from_address_id" id="bill_from_address_id"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm"
                            hx-get="{{.basePath}}/shipments/wizard/address-preview"
                            hx-target="#bill-from-preview"
                            hx-include="[name='bill_from_address_id']"
                            hx-trigger="change">
                        <option value="">Select address...</option>
                        {{range .billFromAddresses}}
                        <option value="{{.ID}}">{{index .Data "Company Name"}}</option>
                        {{end}}
                    </select>
                    <div id="bill-from-preview" class="mt-2"></div>
                </div>

                <!-- Dispatch From Address -->
                <div>
                    <label for="dispatch_from_address_id" class="block text-sm font-medium text-gray-700 mb-1">Dispatch From Address</label>
                    <select name="dispatch_from_address_id" id="dispatch_from_address_id"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm"
                            hx-get="{{.basePath}}/shipments/wizard/address-preview"
                            hx-target="#dispatch-from-preview"
                            hx-include="[name='dispatch_from_address_id']"
                            hx-trigger="change">
                        <option value="">Select address...</option>
                        {{range .dispatchFromAddresses}}
                        <option value="{{.ID}}">{{index .Data "Company Name"}}</option>
                        {{end}}
                    </select>
                    <div id="dispatch-from-preview" class="mt-2"></div>
                </div>

                <!-- Bill To Address -->
                <div>
                    <label for="bill_to_address_id" class="block text-sm font-medium text-gray-700 mb-1">Bill To Address <span class="text-red-500">*</span></label>
                    <select name="bill_to_address_id" id="bill_to_address_id" required
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm"
                            hx-get="{{.basePath}}/shipments/wizard/address-preview"
                            hx-target="#bill-to-preview"
                            hx-include="[name='bill_to_address_id']"
                            hx-trigger="change">
                        <option value="">Select address...</option>
                        {{range .billToAddresses}}
                        <option value="{{.ID}}">{{index .Data "Company Name"}}</option>
                        {{end}}
                    </select>
                    <div id="bill-to-preview" class="mt-2"></div>
                </div>

                <!-- Ship To Addresses -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ship To Addresses <span class="text-red-500">*</span></label>
                    <div id="ship-to-container">
                        {{range $i := seq 1 .formData.NumSets}}
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ship To - Set {{$i}}</label>
                            <select name="ship_to_address_{{$i}}" required class="ship-to-select w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm">
                                <option value="">Select address...</option>
                                {{range $.shipToAddresses}}
                                <option value="{{.ID}}">{{.DistrictName}} - {{.MandalName}}</option>
                                {{end}}
                            </select>
                        </div>
                        {{end}}
                    </div>
                </div>

                <!-- Transit DC Ship To -->
                <div>
                    <label for="transit-ship-to" class="block text-sm font-medium text-gray-700 mb-1">Transit DC Ship To <span class="text-red-500">*</span></label>
                    <select name="transit_ship_to_address_id" id="transit-ship-to" required
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm">
                        <option value="">Select from ship-to addresses above...</option>
                    </select>
                </div>

            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="{{.basePath}}/shipments/wizard/step1?back=true" class="btn btn-secondary">&larr; Back</a>
            <button type="submit" class="btn btn-primary">Next: Serials &rarr;</button>
        </div>
    </form>
</div>

<script>
document.querySelectorAll('.ship-to-select').forEach(function(sel) {
    sel.addEventListener('change', updateTransitShipTo);
});

function updateTransitShipTo() {
    var transitSelect = document.getElementById('transit-ship-to');
    var selected = new Map();
    document.querySelectorAll('.ship-to-select').forEach(function(sel) {
        if (sel.value) {
            selected.set(sel.value, sel.options[sel.selectedIndex].text);
        }
    });
    transitSelect.innerHTML = '<option value="">Select from ship-to addresses above...</option>';
    selected.forEach(function(text, val) {
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = text;
        transitSelect.appendChild(opt);
    });
}
</script>
{{ end }}
