{{ define "title" }}New Shipment - Serial Numbers{{ end }}

{{ define "content" }}
<div class="max-w-5xl mx-auto">
    {{ template "wizard_steps" . }}

    <form method="POST" action="/projects/{{.project.ID}}/shipments/wizard/step4" id="wizard-step3-form">
        {{.csrfField}}

        <!-- Carry forward hidden fields -->
        <input type="hidden" name="template_id" value="{{.templateID}}">
        <input type="hidden" name="num_sets" value="{{.numSets}}">
        <input type="hidden" name="challan_date" value="{{.challanDate}}">
        <input type="hidden" name="transporter_name" value="{{.transporterName}}">
        <input type="hidden" name="vehicle_number" value="{{.vehicleNumber}}">
        <input type="hidden" name="eway_bill_number" value="{{.ewayBillNumber}}">
        <input type="hidden" name="docket_number" value="{{.docketNumber}}">
        <input type="hidden" name="tax_type" value="{{.taxType}}">
        <input type="hidden" name="reverse_charge" value="{{.reverseCharge}}">
        <input type="hidden" name="bill_from_address_id" value="{{.billFromAddressID}}">
        <input type="hidden" name="dispatch_from_address_id" value="{{.dispatchFromAddressID}}">
        <input type="hidden" name="bill_to_address_id" value="{{.billToAddressID}}">
        <input type="hidden" name="transit_ship_to_address_id" value="{{.transitShipToAddrID}}">
        {{range .shipToAddressIDs}}
        <input type="hidden" name="ship_to_address_ids" value="{{.}}">
        {{end}}

        {{if .products}}
        {{range $i, $p := .products}}
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">{{$p.ItemName}}</h3>
                <span class="text-sm text-gray-500" id="counter-{{$p.ID}}">
                    Entered: 0 / Required: {{mul $p.DefaultQuantity $.numSets}}
                </span>
            </div>
            <p class="text-sm text-gray-500 mb-3">
                Enter {{mul $p.DefaultQuantity $.numSets}} serial numbers ({{$p.DefaultQuantity}} per set × {{$.numSets}} sets), one per line
            </p>
            <textarea
                id="serials-textarea-{{$p.ID}}"
                rows="8"
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm font-mono"
                placeholder="Enter serial numbers, one per line..."
                data-product-id="{{$p.ID}}"
                data-required="{{mul $p.DefaultQuantity $.numSets}}"
                oninput="SerialAssignment.handleSerialInput(this, {{$.project.ID}}, window._csrfToken || '')">
            <div id="serial-errors-{{$p.ID}}" class="mt-2"></div>

            <!-- Assignment grid rendered by JS -->
            <div id="assignment-{{$p.ID}}" class="mt-4 hidden"></div>
        </div>
        {{end}}
        {{else}}
        <div class="card mb-6">
            <p class="text-sm text-gray-500 text-center py-8">No products in selected template.</p>
        </div>
        {{end}}

        <div class="flex items-center justify-between mt-6">
            <a href="javascript:history.back()" class="btn btn-secondary">← Back</a>
            <button type="submit" class="btn btn-primary" id="step3-next">Next: Review →</button>
        </div>
    </form>
</div>

<script src="/static/js/serial-assignment.js"></script>
<script>
(function() {
    // Extract CSRF token from the form's hidden field
    var csrfInput = document.querySelector('#wizard-step3-form input[name="gorilla.csrf.Token"]');
    window._csrfToken = csrfInput ? csrfInput.value : '';
    // Initialize product state with destinations
    var destinations = [
        {{range $.shipToAddresses}}
        { id: {{.ID}}, name: "{{.MandalName}}{{if .DistrictName}} ({{.DistrictName}}){{end}}", qty: 0 },
        {{end}}
    ];

    {{range $i, $p := .products}}
    // Set qty per set for each destination
    var dests_{{$p.ID}} = destinations.map(function(d) {
        return { id: d.id, name: d.name, qty: {{$p.DefaultQuantity}} };
    });
    SerialAssignment.initProduct({{$p.ID}}, {{mul $p.DefaultQuantity $.numSets}}, dests_{{$p.ID}});
    {{end}}
})();
</script>
{{ end }}
