{{ define "form.html" }}
<div class="flex flex-col h-full">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">{{ if .isEdit }}Edit Product{{ else }}Add Product{{ end }}</h2>
        <button onclick="closeProductSlideOver()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    {{ if .successMessage }}
    <div class="mx-6 mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
        <p class="text-sm text-green-700">{{ .successMessage }}</p>
    </div>
    {{ end }}

    {{ if .errors.general }}
    <div class="mx-6 mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
        <p class="text-sm text-red-700">{{ .errors.general }}</p>
    </div>
    {{ end }}

    <form class="flex-1 overflow-y-auto px-6 py-4 space-y-4"
          {{ if .isEdit }}
          hx-post="/projects/{{ .projectID }}/products/{{ .product.ID }}"
          {{ else }}
          hx-post="/projects/{{ .projectID }}/products"
          {{ end }}
          hx-target="#product-form-container"
          hx-swap="innerHTML"
          id="product-form">

        {{ .csrfField }}

        <div>
            <label for="item_name" class="block text-sm font-medium text-gray-700">Item Name <span class="text-red-500">*</span></label>
            <input type="text" name="item_name" id="item_name" value="{{ .product.ItemName }}"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm {{ if .errors.item_name }}border-red-300{{ end }}"
                   required>
            {{ if .errors.item_name }}<p class="mt-1 text-xs text-red-600">{{ .errors.item_name }}</p>{{ end }}
        </div>

        <div>
            <label for="item_description" class="block text-sm font-medium text-gray-700">Description <span class="text-red-500">*</span></label>
            <textarea name="item_description" id="item_description" rows="2"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm {{ if .errors.item_description }}border-red-300{{ end }}"
                      required>{{ .product.ItemDescription }}</textarea>
            {{ if .errors.item_description }}<p class="mt-1 text-xs text-red-600">{{ .errors.item_description }}</p>{{ end }}
        </div>

        <div>
            <label for="hsn_code" class="block text-sm font-medium text-gray-700">HSN Code</label>
            <input type="text" name="hsn_code" id="hsn_code" value="{{ .product.HSNCode }}"
                   placeholder="e.g. 94054090"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm {{ if .errors.hsn_code }}border-red-300{{ end }}">
            <p class="mt-1 text-xs text-gray-400">6-8 digit code (optional)</p>
            {{ if .errors.hsn_code }}<p class="mt-1 text-xs text-red-600">{{ .errors.hsn_code }}</p>{{ end }}
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="uom" class="block text-sm font-medium text-gray-700">UoM <span class="text-red-500">*</span></label>
                <select name="uom" id="uom"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm">
                    <option value="Nos" {{ if eq .product.UoM "Nos" }}selected{{ end }}>Nos</option>
                    <option value="Mtr" {{ if eq .product.UoM "Mtr" }}selected{{ end }}>Mtr</option>
                    <option value="Kg" {{ if eq .product.UoM "Kg" }}selected{{ end }}>Kg</option>
                    <option value="Set" {{ if eq .product.UoM "Set" }}selected{{ end }}>Set</option>
                    <option value="Lot" {{ if eq .product.UoM "Lot" }}selected{{ end }}>Lot</option>
                    <option value="Pair" {{ if eq .product.UoM "Pair" }}selected{{ end }}>Pair</option>
                    <option value="Box" {{ if eq .product.UoM "Box" }}selected{{ end }}>Box</option>
                    <option value="Rmt" {{ if eq .product.UoM "Rmt" }}selected{{ end }}>Rmt</option>
                </select>
                {{ if .errors.uom }}<p class="mt-1 text-xs text-red-600">{{ .errors.uom }}</p>{{ end }}
            </div>
            <div>
                <label for="brand_model" class="block text-sm font-medium text-gray-700">Brand/Model <span class="text-red-500">*</span></label>
                <input type="text" name="brand_model" id="brand_model" value="{{ .product.BrandModel }}"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm {{ if .errors.brand_model }}border-red-300{{ end }}"
                       required>
                {{ if .errors.brand_model }}<p class="mt-1 text-xs text-red-600">{{ .errors.brand_model }}</p>{{ end }}
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="per_unit_price" class="block text-sm font-medium text-gray-700">Per Unit Price <span class="text-red-500">*</span></label>
                <input type="number" name="per_unit_price" id="per_unit_price" value="{{ if gt .product.PerUnitPrice 0.0 }}{{ printf "%.2f" .product.PerUnitPrice }}{{ end }}"
                       step="0.01" min="0.01"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm {{ if .errors.per_unit_price }}border-red-300{{ end }}"
                       oninput="updateGSTPreview()" required>
                {{ if .errors.per_unit_price }}<p class="mt-1 text-xs text-red-600">{{ .errors.per_unit_price }}</p>{{ end }}
            </div>
            <div>
                <label for="gst_percentage" class="block text-sm font-medium text-gray-700">GST % <span class="text-red-500">*</span></label>
                <select name="gst_percentage" id="gst_percentage"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm"
                        onchange="updateGSTPreview()">
                    <option value="0" {{ if eq (printf "%.0f" .product.GSTPercentage) "0" }}selected{{ end }}>0%</option>
                    <option value="5" {{ if eq (printf "%.0f" .product.GSTPercentage) "5" }}selected{{ end }}>5%</option>
                    <option value="12" {{ if eq (printf "%.0f" .product.GSTPercentage) "12" }}selected{{ end }}>12%</option>
                    <option value="18" {{ if eq (printf "%.0f" .product.GSTPercentage) "18" }}selected{{ end }}>18%</option>
                    <option value="28" {{ if eq (printf "%.0f" .product.GSTPercentage) "28" }}selected{{ end }}>28%</option>
                </select>
                {{ if .errors.gst_percentage }}<p class="mt-1 text-xs text-red-600">{{ .errors.gst_percentage }}</p>{{ end }}
            </div>
        </div>

        <!-- GST Price Preview -->
        <div id="gst-preview" class="p-3 bg-blue-50 border border-blue-200 rounded-md {{ if not (gt .product.PerUnitPrice 0.0) }}hidden{{ end }}">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Price with GST:</span>
                <span id="gst-preview-amount" class="font-semibold text-gray-900">
                    {{ if gt .product.PerUnitPrice 0.0 }}{{ printf "%.2f" .product.PriceWithGST }}{{ end }}
                </span>
            </div>
        </div>

        <!-- Hidden field for save_and_add -->
        <input type="hidden" name="save_and_add" id="save_and_add_field" value="false">

        <div class="pt-4 border-t border-gray-200 flex flex-col gap-2">
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeProductSlideOver()" class="btn btn-secondary text-sm">Cancel</button>
                {{ if not .isEdit }}
                <button type="button" onclick="saveAndAddAnother()" class="btn btn-secondary text-sm">Save & Add Another</button>
                {{ end }}
                <button type="submit" class="btn btn-primary text-sm">
                    {{ if .isEdit }}Update Product{{ else }}Add Product{{ end }}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function updateGSTPreview() {
    var price = parseFloat(document.getElementById('per_unit_price').value) || 0;
    var gst = parseFloat(document.getElementById('gst_percentage').value) || 0;
    var preview = document.getElementById('gst-preview');
    var amount = document.getElementById('gst-preview-amount');

    if (price > 0) {
        var total = price * (1 + gst / 100);
        amount.textContent = total.toFixed(2);
        preview.classList.remove('hidden');
    } else {
        preview.classList.add('hidden');
    }
}

function saveAndAddAnother() {
    document.getElementById('save_and_add_field').value = 'true';
    htmx.trigger(document.getElementById('product-form'), 'submit');
}

// Initialize preview on load
updateGSTPreview();
</script>
{{ end }}
